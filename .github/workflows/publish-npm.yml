name: publish-npm

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to publish (vX.Y.Z)"
        required: true

jobs:
  build-binary:
    name: build ${{ matrix.platform }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: darwin-arm64
            runner: macos-14
          - platform: darwin-x64
            runner: macos-15-intel
          - platform: linux-x64-gnu
            runner: ubuntu-22.04
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - uses: pnpm/action-setup@v4
        with:
          version: "10"

      - name: Install
        run: pnpm install

      - name: Test
        run: pnpm test

      - name: Build binary
        run: pnpm build:binary

      - name: Upload binary
        uses: actions/upload-artifact@v4
        with:
          name: mailbox-${{ matrix.platform }}
          path: mailbox-cli/packages/mailbox-cli-${{ matrix.platform }}/bin/mailbox
          if-no-files-found: error

  publish:
    runs-on: ubuntu-22.04
    needs: build-binary
    environment: npm
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          registry-url: "https://registry.npmjs.org"

      - name: Ensure npm supports OIDC publish
        shell: bash
        run: |
          set -euo pipefail
          npm i -g npm@^11.5.1
          npm --version

      - uses: pnpm/action-setup@v4
        with:
          version: "10"

      - name: Install
        run: pnpm install

      - name: Force OIDC (ignore legacy tokens)
        shell: bash
        run: |
          set -euo pipefail
          unset NODE_AUTH_TOKEN || true
          unset NPM_TOKEN || true
          if [ -n "${NPM_CONFIG_USERCONFIG:-}" ] && [ -f "$NPM_CONFIG_USERCONFIG" ]; then
            sed -i '/_authToken/d' "$NPM_CONFIG_USERCONFIG" || true
          fi
          npm config delete //registry.npmjs.org/:_authToken || true
          npm config list

      - name: Download binaries
        uses: actions/download-artifact@v4
        with:
          path: .artifacts

      - name: Place binaries into platform packages
        shell: bash
        run: |
          set -euo pipefail

          for platform in darwin-arm64 darwin-x64 linux-x64-gnu; do
            src=".artifacts/mailbox-${platform}/mailbox"
            dest="mailbox-cli/packages/mailbox-cli-${platform}/bin/mailbox"
            mkdir -p "$(dirname "$dest")"
            cp "$src" "$dest"
            chmod +x "$dest" || true
          done

      - name: Set version
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${GITHUB_EVENT_NAME}" == "workflow_dispatch" ]]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION="${GITHUB_REF_NAME}"
          fi
          node scripts/set_release_version.js "$VERSION"

      - name: Publish platform packages
        shell: bash
        run: |
          set -euo pipefail
          npm publish --access public "mailbox-cli/packages/mailbox-cli-darwin-arm64"
          npm publish --access public "mailbox-cli/packages/mailbox-cli-darwin-x64"
          npm publish --access public "mailbox-cli/packages/mailbox-cli-linux-x64-gnu"

      - name: Publish launcher package
        run: npm publish --access public mailbox-cli/packages/mailbox-cli
