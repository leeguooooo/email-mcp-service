# é‚®ä»¶åŒæ­¥éªŒè¯æŒ‡å—

**æ—¥æœŸ**: 2025-10-15  
**çŠ¶æ€**: âœ… å·²éªŒè¯

---

## ğŸš€ å¿«é€ŸéªŒè¯

### 1. è¿è¡Œæµ‹è¯•è„šæœ¬

```bash
# å®Œæ•´æµ‹è¯•ï¼ˆæ¨èï¼‰
python3 test_sync.py

# æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
tail -f test_sync.log
```

### 2. ä½¿ç”¨MCPå·¥å…·éªŒè¯

```bash
# å¯åŠ¨MCPæœåŠ¡å™¨
./run.sh

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æˆ–é€šè¿‡MCPå®¢æˆ·ç«¯è°ƒç”¨ï¼š

# è·å–åŒæ­¥çŠ¶æ€
mcp call sync_emails '{"action": "status"}'

# å¼ºåˆ¶åŒæ­¥
mcp call sync_emails '{"action": "force"}'

# æœç´¢ç¼“å­˜é‚®ä»¶
mcp call sync_emails '{"action": "search", "query": "å…³é”®è¯"}'

# æŸ¥çœ‹å¥åº·çŠ¶æ€
mcp call get_sync_health

# æŸ¥çœ‹åŒæ­¥å†å²
mcp call get_sync_history '{"hours": 24}'

# æŸ¥çœ‹è¿æ¥æ± ç»Ÿè®¡
mcp call get_connection_pool_stats
```

---

## ğŸ“Š éªŒè¯ç»“æœç¤ºä¾‹

### æµ‹è¯•è¾“å‡º
```
ğŸš€ é‚®ä»¶åŒæ­¥æµ‹è¯•å¼€å§‹ - 2025-10-15 17:09:43
ğŸ“ æ—¥å¿—æ–‡ä»¶: test_sync.log

============================================================
æµ‹è¯• 1: æ£€æŸ¥åŒæ­¥çŠ¶æ€
============================================================
âœ… åŒæ­¥ç®¡ç†å™¨åˆå§‹åŒ–æˆåŠŸ
ğŸ“Š åŒæ­¥çŠ¶æ€: {...}

============================================================
æµ‹è¯• 2: å¼ºåˆ¶åŒæ­¥
============================================================
ğŸ“§ æµ‹è¯•è´¦æˆ·: example@163.com
ğŸ”„ å¼€å§‹åŒæ­¥...
âœ… åŒæ­¥å®Œæˆ!
ğŸ“Š ç»“æœ: {
    'success': True,
    'folders_synced': 23,
    'emails_added': 103,
    'emails_updated': 0
}

============================================================
æµ‹è¯• 3: æœç´¢ç¼“å­˜é‚®ä»¶
============================================================
ğŸ” è·å–æœ€è¿‘20å°é‚®ä»¶...
âœ… æ‰¾åˆ° 20 å°ç¼“å­˜é‚®ä»¶
   1. é‚®ä»¶ä¸»é¢˜1
      å‘ä»¶äºº: å‘ä»¶äºº1
      æ—¶é—´: 2025-10-15 17:06:05
   ...

============================================================
æµ‹è¯• 4: å¥åº·ç›‘æ§
============================================================
âœ… æ•´ä½“å¥åº·çŠ¶å†µ: healthy
ğŸ“Š ç»Ÿè®¡:
   - æ€»è´¦æˆ·æ•°: 1
   - å¥åº·è´¦æˆ·: 1
   - å¹³å‡åˆ†æ•°: 100.0/100
   - æˆåŠŸç‡: 100.0%

============================================================
æµ‹è¯• 5: è¿æ¥æ± ç»Ÿè®¡
============================================================
âœ… è¿æ¥æ± ç»Ÿè®¡:
   - æ€»åˆ›å»º: 1
   - å¤ç”¨æ¬¡æ•°: 0
   - å·²å…³é—­: 0
   - æ´»è·ƒè¿æ¥: 1

æ€»è®¡: 5/5 æµ‹è¯•é€šè¿‡
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!
```

---

## ğŸ“ æ—¥å¿—ä½ç½®

### 1. æµ‹è¯•æ—¥å¿—
```bash
# æŸ¥çœ‹æµ‹è¯•æ—¥å¿—
cat test_sync.log

# å®æ—¶ç›‘æ§
tail -f test_sync.log
```

### 2. åŒæ­¥æ—¥å¿—ï¼ˆå¦‚æœé…ç½®äº†ï¼‰
```bash
# é…ç½®æ–‡ä»¶: sync_config.json
cat sync.log

# å®æ—¶ç›‘æ§
tail -f sync.log
```

### 3. åº”ç”¨ç¨‹åºæ—¥å¿—
```bash
# å¦‚æœé€šè¿‡MCPæœåŠ¡å™¨è¿è¡Œ
# æ—¥å¿—ä¼šè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡º
./run.sh 2>&1 | tee mcp_server.log
```

### 4. å¥åº·ç›‘æ§å†å²
```bash
# æŸ¥çœ‹å¥åº·ç›‘æ§å†å²ï¼ˆJSONæ ¼å¼ï¼‰
cat sync_health_history.json | python3 -m json.tool
```

---

## ğŸ” æ£€æŸ¥åŒæ­¥æ•°æ®

### æŸ¥çœ‹æ•°æ®åº“
```bash
# ä½¿ç”¨SQLiteæŸ¥çœ‹åŒæ­¥çš„é‚®ä»¶
sqlite3 email_sync.db

# æŸ¥çœ‹è´¦æˆ·
sqlite> SELECT * FROM accounts;

# æŸ¥çœ‹æ–‡ä»¶å¤¹
sqlite> SELECT * FROM folders;

# æŸ¥çœ‹é‚®ä»¶æ•°é‡
sqlite> SELECT COUNT(*) FROM emails;

# æŸ¥çœ‹æœ€è¿‘é‚®ä»¶
sqlite> SELECT subject, sender, date_sent 
        FROM emails 
        ORDER BY date_sent DESC 
        LIMIT 10;

# é€€å‡º
sqlite> .quit
```

### ä½¿ç”¨Pythonè„šæœ¬
```python
import sqlite3

conn = sqlite3.connect('email_sync.db')
cursor = conn.cursor()

# æŸ¥çœ‹è´¦æˆ·
cursor.execute("SELECT id, email, provider FROM accounts")
print("è´¦æˆ·:", cursor.fetchall())

# æŸ¥çœ‹é‚®ä»¶æ•°
cursor.execute("SELECT COUNT(*) FROM emails")
print("æ€»é‚®ä»¶æ•°:", cursor.fetchone()[0])

# æŸ¥çœ‹æœªè¯»é‚®ä»¶æ•°
cursor.execute("SELECT COUNT(*) FROM emails WHERE is_read = 0")
print("æœªè¯»é‚®ä»¶:", cursor.fetchone()[0])

conn.close()
```

---

## ğŸ› å¸¸è§é—®é¢˜

### é—®é¢˜1: ç¼ºå°‘scheduleæ¨¡å—
```bash
# é”™è¯¯: ModuleNotFoundError: No module named 'schedule'

# è§£å†³:
pip3 install schedule
# æˆ–
uv pip install schedule
```

### é—®é¢˜2: å¾ªç¯å¯¼å…¥é”™è¯¯
```bash
# é”™è¯¯: ImportError: circular import

# è§£å†³: å·²åœ¨ä»£ç ä¸­ä½¿ç”¨å»¶è¿Ÿå¯¼å…¥ä¿®å¤
# ç¡®ä¿ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬çš„ä»£ç 
```

### é—®é¢˜3: æ²¡æœ‰çœ‹åˆ°æ—¥å¿—
```bash
# åŸå› : æ—¥å¿—çº§åˆ«å¤ªé«˜æˆ–æœªé…ç½®

# è§£å†³1: æ£€æŸ¥é…ç½®
cat sync_config.json | grep -A 5 '"logging"'

# è§£å†³2: è¿è¡Œæµ‹è¯•è„šæœ¬ï¼ˆè‡ªåŠ¨é…ç½®æ—¥å¿—ï¼‰
python3 test_sync.py

# è§£å†³3: å¯ç”¨æ–‡ä»¶æ—¥å¿—
# ç¼–è¾‘ sync_config.json:
{
  "logging": {
    "level": "INFO",
    "file_enabled": true,
    "file_path": "sync.log"
  }
}
```

### é—®é¢˜4: è´¦æˆ·å¥åº·çŠ¶æ€æ˜¾ç¤º "no_accounts"
```bash
# åŸå› : æ²¡æœ‰é…ç½®é‚®ç®±è´¦æˆ·æˆ–è´¦æˆ·æœªåŒæ­¥

# è§£å†³: 
# 1. æ£€æŸ¥accounts.json
cat accounts.json

# 2. è¿è¡Œä¸€æ¬¡åŒæ­¥
python3 test_sync.py

# æˆ–é€šè¿‡MCP
mcp call sync_emails '{"action": "force"}'
```

---

## ğŸ“ˆ æ€§èƒ½ç›‘æ§

### æŸ¥çœ‹åŒæ­¥æ€§èƒ½
```bash
# ä½¿ç”¨MCPå·¥å…·
mcp call get_sync_history '{"hours": 24}'

# è¾“å‡ºç¤ºä¾‹:
ğŸ“œ åŒæ­¥å†å² (æœ€è¿‘ 24 å°æ—¶, æ‰€æœ‰è´¦æˆ·)

âœ… 10-15 17:10 - å¢é‡åŒæ­¥: 103 å°é‚®ä»¶ (8.2ç§’)
âœ… 10-15 14:55 - å¢é‡åŒæ­¥: 45 å°é‚®ä»¶ (5.1ç§’)
âœ… 10-15 14:40 - å¢é‡åŒæ­¥: 23 å°é‚®ä»¶ (3.5ç§’)
```

### æŸ¥çœ‹è¿æ¥æ± æ•ˆç‡
```bash
mcp call get_connection_pool_stats

# è¾“å‡ºç¤ºä¾‹:
ğŸ”Œ IMAP è¿æ¥æ± ç»Ÿè®¡

â€¢ æ€»åˆ›å»ºè¿æ¥æ•°: 15
â€¢ å¤ç”¨æ¬¡æ•°: 145
â€¢ å·²å…³é—­è¿æ¥æ•°: 3
â€¢ ç­‰å¾…æ¬¡æ•°: 2
â€¢ ç­‰å¾…è¶…æ—¶æ¬¡æ•°: 0

â€¢ æ´»è·ƒè´¦æˆ·æ•°: 5
â€¢ æ€»æ´»è·ƒè¿æ¥æ•°: 12

ğŸ“ˆ è¿æ¥å¤ç”¨ç‡: 90.6%
```

---

## âš™ï¸ é…ç½®è¯´æ˜

### åŒæ­¥é…ç½® (sync_config.json)
```json
{
  "sync": {
    "enabled": true,              // å¯ç”¨åŒæ­¥
    "auto_start": true,           // è‡ªåŠ¨å¯åŠ¨
    "interval_minutes": 15,       // åŒæ­¥é—´éš”ï¼ˆåˆ†é’Ÿï¼‰
    "full_sync_hours": 24,        // å®Œå…¨åŒæ­¥é—´éš”ï¼ˆå°æ—¶ï¼‰
    "first_sync_days": 180,       // é¦–æ¬¡åŒæ­¥å¤©æ•°
    "incremental_sync_days": 7    // å¢é‡åŒæ­¥å¤©æ•°
  },
  "logging": {
    "level": "INFO",              // æ—¥å¿—çº§åˆ«
    "file_enabled": true,         // å¯ç”¨æ–‡ä»¶æ—¥å¿—
    "file_path": "sync.log"       // æ—¥å¿—æ–‡ä»¶è·¯å¾„
  }
}
```

### æ—¥å¿—çº§åˆ«
- `DEBUG`: è¯¦ç»†è°ƒè¯•ä¿¡æ¯ï¼ˆæœ€è¯¦ç»†ï¼‰
- `INFO`: ä¸€èˆ¬ä¿¡æ¯ï¼ˆæ¨èï¼‰
- `WARNING`: è­¦å‘Šä¿¡æ¯
- `ERROR`: é”™è¯¯ä¿¡æ¯ï¼ˆæœ€ç®€æ´ï¼‰

---

## ğŸ¯ æ¨èéªŒè¯æµç¨‹

### é¦–æ¬¡éªŒè¯
```bash
# 1. å®‰è£…ä¾èµ–
pip3 install schedule

# 2. è¿è¡Œå®Œæ•´æµ‹è¯•
python3 test_sync.py

# 3. æ£€æŸ¥æµ‹è¯•ç»“æœ
# åº”è¯¥çœ‹åˆ°: "ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡!"

# 4. æŸ¥çœ‹åŒæ­¥çš„é‚®ä»¶
sqlite3 email_sync.db "SELECT COUNT(*) FROM emails;"

# 5. æŸ¥çœ‹å¥åº·çŠ¶æ€
python3 -c "
from src.background.sync_health_monitor import get_health_monitor
monitor = get_health_monitor()
import json
print(json.dumps(monitor.get_overall_health(), indent=2))
"
```

### æ—¥å¸¸ç›‘æ§
```bash
# é€šè¿‡MCPå·¥å…·
mcp call get_sync_health
mcp call get_connection_pool_stats

# æˆ–æŸ¥çœ‹æ—¥å¿—
tail -f sync.log
tail -f test_sync.log
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [åŒæ­¥æ”¹è¿›æ–‡æ¡£](./docs/SYNC_IMPROVEMENTS.md)
- [è¿æ¥æ± ä¿®å¤](./docs/CONNECTION_POOL_FIX.md)
- [æ­»é”ä¿®å¤](./docs/DEADLOCK_FIX.md)
- [æ¶æ„æ–‡æ¡£](./docs/ARCHITECTURE.md)

---

## âœ… éªŒè¯æ¸…å•

- [x] å®‰è£…scheduleæ¨¡å—
- [x] ä¿®å¤å¾ªç¯å¯¼å…¥
- [x] è¿è¡Œæµ‹è¯•è„šæœ¬
- [x] æ‰€æœ‰æµ‹è¯•é€šè¿‡ (5/5)
- [x] åŒæ­¥æˆåŠŸ (103å°é‚®ä»¶)
- [x] ç¼“å­˜å¯æœç´¢ (20å°é‚®ä»¶)
- [x] å¥åº·ç›‘æ§æ­£å¸¸ (100/100)
- [x] è¿æ¥æ± æ­£å¸¸ (1ä¸ªè¿æ¥)

**éªŒè¯çŠ¶æ€**: âœ… **å®Œå…¨é€šè¿‡!**


