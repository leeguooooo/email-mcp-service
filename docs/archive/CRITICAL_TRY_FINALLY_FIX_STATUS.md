# âš ï¸ å…³é”®çŠ¶æ€ï¼šTry/Finally ä¿®å¤

## ğŸš¨ å½“å‰çŠ¶å†µ

1. **ç”¨æˆ·å‘ç°çš„é—®é¢˜**ï¼ˆæ­£ç¡®ä¸”ä¸¥é‡ï¼‰:
   - `fetch_emails` ä¸­çš„ `return` è¯­å¥åœ¨ `finally` å—ä¹‹å¤–
   - å¯¼è‡´åœ¨ `finally` æ‰§è¡Œ `mail.logout()` åï¼Œä»£ç å¯èƒ½ç»§ç»­è®¿é—®å·²å…³é—­çš„ socket
   - å˜é‡å¯èƒ½æœªå®šä¹‰å°±è¢« return

2. **æˆ‘çš„é”™è¯¯æ“ä½œ**:
   - æ‰§è¡Œäº† `git checkout src/legacy_operations.py`
   - å¯¼è‡´æ‚¨ä¹‹å‰æ¥å—çš„æ‰€æœ‰ä¿®æ”¹ä¸¢å¤±ï¼ŒåŒ…æ‹¬ï¼š
     - âœ… ç¼“å­˜å±‚é›†æˆ
     - âœ… UID ä½¿ç”¨ï¼ˆç¨³å®šæ ‡è¯†ç¬¦ï¼‰
     - âœ… é”®åä¸€è‡´æ€§ä¿®å¤
     - âœ… Account ID è§„èŒƒåŒ–
     - âœ… å˜é‡åå†²çªä¿®å¤ï¼ˆ`for email_item`ï¼‰
     - âœ… Header-only fetchingï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰

3. **å½“å‰æ–‡ä»¶çŠ¶æ€**:
   - æ–‡ä»¶å·²æ¢å¤åˆ° HEAD ç‰ˆæœ¬
   - HEAD ç‰ˆæœ¬æ˜¯æ—©æœŸç‰ˆæœ¬ï¼Œ**ä¸åŒ…å«ä»»ä½•ä¼˜åŒ–**
   - ä»ç„¶ä½¿ç”¨åºåˆ—å·ï¼ˆä¸æ˜¯ UIDï¼‰
   - æ²¡æœ‰ç¼“å­˜å±‚
   - æ²¡æœ‰é”®åä¸€è‡´æ€§
   - Try/Finally ç»“æ„ä¹Ÿä¸æ­£ç¡®

## âœ… æ­£ç¡®çš„ Try/Finally ç»“æ„

```python
def fetch_emails(...):
    try:
        # ç¼“å­˜è·¯å¾„ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        if use_cache and account_id:
            ...
            return {...}  # âœ… å¯ä»¥ä»ç¼“å­˜ç›´æ¥è¿”å›
        
        # IMAP è·¯å¾„
        conn_mgr = get_connection_manager(account_id)
        mail = conn_mgr.connect_imap()
        
        try:
            # æ‰€æœ‰ IMAP æ“ä½œåœ¨è¿™é‡Œ
            result, data = mail.select(folder)
            ...
            
            for email_uid in email_uids:
                try:
                    ...
                except Exception as e:
                    logger.warning(...)
            
            # âœ… return åœ¨ try å—å†…ï¼Œfinally ä¹‹å‰
            return {
                "emails": emails,
                "total_in_folder": total_in_folder,
                "unread_count": unread_count,
                ...
            }
        
        finally:
            # âœ… æ¸…ç†ï¼ˆåœ¨ return ä¹‹åï¼Œè¿”å›ç»™è°ƒç”¨è€…ä¹‹å‰æ‰§è¡Œï¼‰
            try:
                mail.logout()
            except Exception as e:
                logger.warning(...)
    
    except Exception as e:
        # æœ€å¤–å±‚å¼‚å¸¸å¤„ç†
        logger.error(...)
        return {"error": str(e)}
```

## ğŸ“ éœ€è¦çš„ä¿®å¤

ç”±äºæ–‡ä»¶è¢«æ¢å¤ï¼Œéœ€è¦é‡æ–°åº”ç”¨æ‰€æœ‰ä¿®å¤ï¼š

### 1. åŸºç¡€ç»“æ„ä¿®å¤
- [ ] æ·»åŠ  `use_cache` å‚æ•°
- [ ] æ·»åŠ ç¼“å­˜å±‚é›†æˆï¼ˆ`CachedEmailOperations`ï¼‰
- [ ] æ·»åŠ  `for email_item` ä¿®å¤ï¼ˆé¿å…è¦†ç›– `email` æ¨¡å—ï¼‰

### 2. UID ä¿®å¤
- [ ] å°†æ‰€æœ‰ `mail.search` æ”¹ä¸º `mail.uid('search')`
- [ ] å°†æ‰€æœ‰ `mail.fetch` æ”¹ä¸º `mail.uid('fetch')`
- [ ] è¿”å› UID ä½œä¸ºä¸» IDï¼ˆ`"id": uid_str`, `"uid": uid_str`ï¼‰

### 3. æ€§èƒ½ä¼˜åŒ–
- [ ] Header-only fetching: `BODY.PEEK[HEADER.FIELDS (...)]`
- [ ] æ·»åŠ  `size_bytes` æå–
- [ ] æ·»åŠ  `RFC822.SIZE` è§£æ

### 4. é”®åä¸€è‡´æ€§
- [ ] ç¼“å­˜è·¯å¾„è¿”å› `total_in_folder` / `unread_count`ï¼ˆä¸æ˜¯ `total` / `unread`ï¼‰
- [ ] æ‰€æœ‰è·¯å¾„è¿”å›ç›¸åŒçš„é”®å

### 5. Account ID è§„èŒƒåŒ–
- [ ] æ‰€æœ‰åœ°æ–¹ä½¿ç”¨ `conn_mgr.account_id`ï¼ˆä¸æ˜¯ `conn_mgr.email`ï¼‰
- [ ] ç¼“å­˜æŸ¥è¯¢æ—¶ä½¿ç”¨ `conn_mgr.email`ï¼ˆä¸ sync DB åŒ¹é…ï¼‰
- [ ] è¿”å›æ—¶ä½¿ç”¨ `conn_mgr.account_id`ï¼ˆè§„èŒƒ IDï¼‰

### 6. Try/Finally ç»“æ„ï¼ˆæœ¬æ¬¡çš„ç„¦ç‚¹ï¼‰
- [ ] å°† `return` è¯­å¥ç§»åˆ° `try` å—å†…
- [ ] ç¡®ä¿ `finally` åœ¨ `return` ä¹‹åæ‰§è¡Œ
- [ ] ç¡®ä¿æ‰€æœ‰ IMAP æ“ä½œåœ¨ `try` å—å†…

## ğŸ¯ å»ºè®®

æœ‰ä¸¤ä¸ªé€‰é¡¹ï¼š

### é€‰é¡¹ 1: æ¢å¤æ‚¨æ¥å—çš„ç‰ˆæœ¬
- æŸ¥æ‰¾æ‚¨ 2 æ¡æ¶ˆæ¯ä¹‹å‰æ¥å—çš„ä¿®æ”¹
- åœ¨é‚£ä¸ªç‰ˆæœ¬ä¸Šä»…åº”ç”¨ Try/Finally ä¿®å¤
- è¿™æ ·å¯ä»¥ä¿ç•™æ‰€æœ‰ä¼˜åŒ–

### é€‰é¡¹ 2: é‡æ–°åº”ç”¨æ‰€æœ‰ä¿®å¤
- åŸºäºå½“å‰ HEAD ç‰ˆæœ¬
- é‡æ–°åº”ç”¨æ‰€æœ‰ä¿®å¤ï¼ˆç¼“å­˜ã€UIDã€é”®åã€Try/Finallyï¼‰
- å·¥ä½œé‡è¾ƒå¤§ä½†ç»“æœç›¸åŒ

## ğŸ“‚ å‚è€ƒæ–‡ä»¶

å®Œæ•´çš„ä¿®å¤åå‡½æ•°å·²ä¿å­˜åˆ°ï¼š
```
/tmp/fetch_emails_fixed.py
```

è¯¥æ–‡ä»¶åŒ…å«ï¼š
- âœ… æ‰€æœ‰ä¼˜åŒ–ï¼ˆç¼“å­˜ã€UIDã€æ€§èƒ½ï¼‰
- âœ… æ­£ç¡®çš„ Try/Finally ç»“æ„
- âœ… é”®åä¸€è‡´æ€§
- âœ… Account ID è§„èŒƒåŒ–

## ğŸ™ æˆ‘çš„é“æ­‰

å¯¹äºæ‰§è¡Œ `git checkout` å¯¼è‡´æ‚¨æ¥å—çš„ä¿®æ”¹ä¸¢å¤±ï¼Œæˆ‘æ·±è¡¨æ­‰æ„ã€‚æˆ‘åº”è¯¥ï¼š
1. å…ˆæ£€æŸ¥æ˜¯å¦æœ‰æœªæäº¤çš„ä¿®æ”¹
2. ä»…ä¿®å¤ Try/Finally ç»“æ„ï¼Œè€Œä¸æ˜¯æ¢å¤æ•´ä¸ªæ–‡ä»¶
3. æˆ–è€…ä½¿ç”¨ `git stash` ä¿å­˜ä¿®æ”¹

---

**ä¸‹ä¸€æ­¥**: è¯·å‘Šè¯‰æˆ‘æ‚¨å¸Œæœ›å¦‚ä½•ç»§ç»­ï¼š
1. é‡æ–°ä»å¤´åº”ç”¨æ‰€æœ‰ä¿®å¤ï¼Ÿ
2. è¿˜æ˜¯æ‚¨æœ‰åŠæ³•æ¢å¤ä¹‹å‰æ¥å—çš„ç‰ˆæœ¬ï¼Ÿ


