# UID ç¨³å®šæ€§ä¿®å¤ - list_emails

## ğŸš¨ é—®é¢˜æè¿°

### å‘ç°çš„ä¸¥é‡é—®é¢˜

åœ¨ `list_emails` çš„æ€§èƒ½ä¼˜åŒ–ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†**åºåˆ—å·ï¼ˆsequence numbersï¼‰**è€Œä¸æ˜¯ **UID**ï¼Œå¯¼è‡´ä¸¥é‡çš„ç¨³å®šæ€§é—®é¢˜ã€‚

#### âŒ é—®é¢˜ 1: ä½¿ç”¨åºåˆ—å·æœç´¢å’Œè·å–ï¼ˆHighï¼‰

**æ–‡ä»¶**: `src/legacy_operations.py:207-228`

```python
# é—®é¢˜ä»£ç 
result, data = mail.search(None, 'UNSEEN')  # è¿”å›åºåˆ—å·
email_ids = data[0].split()  # åºåˆ—å·åˆ—è¡¨

for email_id in email_ids:
    result, data = mail.fetch(email_id, fetch_parts)  # ç”¨åºåˆ—å·è·å–
```

**é£é™©**ï¼š
- åºåˆ—å·æ˜¯**å¯å˜çš„**ï¼šå½“æ–°é‚®ä»¶åˆ°è¾¾æˆ–æ—§é‚®ä»¶è¢«åˆ é™¤æ—¶ï¼Œåºåˆ—å·ä¼šæ”¹å˜
- æ—¶é—´çª—å£é—®é¢˜ï¼š
  1. `list_emails` åœ¨ 10:00 è¿”å› `id=50`ï¼ˆé‚®ä»¶ Aï¼‰
  2. 10:01 æœ‰æ–°é‚®ä»¶åˆ°è¾¾
  3. 10:02 ç”¨æˆ·ç‚¹å‡»æŸ¥çœ‹ `id=50`
  4. **ç°åœ¨ `50` æŒ‡å‘çš„æ˜¯é‚®ä»¶ B**ï¼ˆä¸æ˜¯é‚®ä»¶ Aï¼‰
- **ç»“æœ**ï¼šç”¨æˆ·çœ‹åˆ°é”™è¯¯çš„é‚®ä»¶å†…å®¹ï¼

---

#### âŒ é—®é¢˜ 2: è¿”å›åºåˆ—å·ä½œä¸º IDï¼ˆHighï¼‰

**æ–‡ä»¶**: `src/legacy_operations.py:286`

```python
# é—®é¢˜ä»£ç 
email_info = {
    "id": email_id,  # åºåˆ—å· - ä¸ç¨³å®šï¼
    "from": from_addr,
    ...
}
```

**é£é™©**ï¼š
- å‰ç«¯å­˜å‚¨ `id=50`
- å‡ åˆ†é’Ÿåç”¨æˆ·ç‚¹å‡»
- é‚®ç®±çŠ¶æ€å·²å˜åŒ–ï¼ˆæ–°é‚®ä»¶/åˆ é™¤é‚®ä»¶ï¼‰
- `id=50` ç°åœ¨æŒ‡å‘ä¸åŒçš„é‚®ä»¶
- **è·¨é‚®ä»¶æ··æ·†**

---

#### âŒ é—®é¢˜ 3: è¿æ¥æ³„æ¼ï¼ˆHighï¼‰

**æ–‡ä»¶**: `src/legacy_operations.py:198`

```python
# é—®é¢˜ä»£ç 
mail = conn_mgr.connect_imap()
# ... æ“ä½œ
mail.logout()  # å¦‚æœä¸­é—´å‡ºé”™ï¼Œæ°¸è¿œæ‰§è¡Œä¸åˆ°è¿™é‡Œ
```

**é£é™©**ï¼š
- ä»»ä½•å¼‚å¸¸ï¼ˆç½‘ç»œé”™è¯¯ã€è§£æé”™è¯¯ç­‰ï¼‰ä¼šè·³è¿‡ `logout()`
- IMAP è¿æ¥ä¿æŒæ‰“å¼€çŠ¶æ€
- æœåŠ¡å™¨è¿æ¥æ•°è€—å°½
- **ç³»ç»Ÿæ— æ³•å†è¿æ¥ IMAP**

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤ 1: ä½¿ç”¨ UID æœç´¢å’Œè·å–

```python
# ä¿®å¤å
# CRITICAL: Use UID search instead of sequence numbers
# UIDs are stable even when messages are added/deleted
if unread_only:
    result, data = mail.uid('search', None, 'UNSEEN')
else:
    result, data = mail.uid('search', None, 'ALL')

email_uids = data[0].split()  # UIDs - ç¨³å®šä¸å˜

# Fetch using UID
for email_uid in email_uids:
    result, data = mail.uid('fetch', email_uid, fetch_parts)
```

**æ•ˆæœ**ï¼š
- âœ… **ç¨³å®šæ ‡è¯†ç¬¦**ï¼šUID æ°¸è¿œæŒ‡å‘åŒä¸€å°é‚®ä»¶
- âœ… **ä¸å—æ–°é‚®ä»¶å½±å“**ï¼šæ–°é‚®ä»¶æœ‰æ–° UIDï¼Œä¸å½±å“ç°æœ‰ UID
- âœ… **ä¸å—åˆ é™¤å½±å“**ï¼šåˆ é™¤é‚®ä»¶ä¸æ”¹å˜å…¶ä»–é‚®ä»¶çš„ UID
- âœ… **å¯é è·Ÿè¸ª**ï¼šå‰ç«¯å¯ä»¥å®‰å…¨åœ°å­˜å‚¨å’Œä½¿ç”¨ UID

---

### ä¿®å¤ 2: è¿”å› UID ä½œä¸ºä¸» ID

```python
# ä¿®å¤å
# CRITICAL: Return UID as the primary ID (stable identifier)
uid_str = email_uid.decode() if isinstance(email_uid, bytes) else str(email_uid)

email_info = {
    "id": uid_str,  # UID - stable even when messages are added/deleted
    "uid": uid_str,  # Explicit UID field for clarity
    "from": from_addr,
    "subject": subject,
    ...
}
```

**æ•ˆæœ**ï¼š
- âœ… **ç¨³å®šçš„ ID**ï¼šå‰ç«¯å­˜å‚¨çš„ ID æ°¸è¿œæœ‰æ•ˆ
- âœ… **æ˜ç¡®çš„ UID å­—æ®µ**ï¼šåŒæ—¶æä¾› `id` å’Œ `uid` å­—æ®µ
- âœ… **å‘åå…¼å®¹**ï¼š`id` å­—æ®µä¿æŒï¼Œåªæ˜¯å€¼æ”¹ä¸º UID
- âœ… **ä¸€è‡´æ€§**ï¼šä¸ `search_emails` å’Œ `get_email_detail` ä¸€è‡´

---

### ä¿®å¤ 3: try/finally ä¿æŠ¤è¿æ¥

```python
# ä¿®å¤å
mail = conn_mgr.connect_imap()

# CRITICAL: Wrap in try/finally to prevent connection leaks
try:
    # ... æ‰€æœ‰ IMAP æ“ä½œ
    
finally:
    # CRITICAL: Always close connection, even if errors occur
    try:
        mail.logout()
    except Exception as e:
        logger.warning(f"Error closing IMAP connection: {e}")
```

**æ•ˆæœ**ï¼š
- âœ… **ä¿è¯æ¸…ç†**ï¼šæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿æ¥éƒ½ä¼šå…³é—­
- âœ… **é˜²æ­¢æ³„æ¼**ï¼šå¼‚å¸¸ä¸ä¼šå¯¼è‡´è¿æ¥ä¿æŒæ‰“å¼€
- âœ… **äºŒæ¬¡ä¿æŠ¤**ï¼šlogout æœ¬èº«çš„å¼‚å¸¸ä¹Ÿè¢«æ•è·
- âœ… **èµ„æºç®¡ç†**ï¼šç³»ç»Ÿå¯ä»¥é•¿æœŸç¨³å®šè¿è¡Œ

---

## ğŸ“Š UID vs åºåˆ—å·å¯¹æ¯”

| ç‰¹æ€§ | åºåˆ—å· | UID | å½±å“ |
|------|--------|-----|------|
| **ç¨³å®šæ€§** | âŒ å¯å˜ | âœ… ä¸å˜ | UID æ°¸è¿œæŒ‡å‘åŒä¸€é‚®ä»¶ |
| **æ–°é‚®ä»¶å½±å“** | âŒ æ”¹å˜ | âœ… æ— å½±å“ | æ–°é‚®ä»¶ä¸å½±å“ç°æœ‰ UID |
| **åˆ é™¤é‚®ä»¶å½±å“** | âŒ æ”¹å˜ | âœ… æ— å½±å“ | åˆ é™¤ä¸æ”¹å˜å…¶ä»– UID |
| **è·¨è®¾å¤‡ä¸€è‡´** | âŒ ä¸ä¸€è‡´ | âœ… ä¸€è‡´ | æ‰€æœ‰å®¢æˆ·ç«¯çœ‹åˆ°ç›¸åŒ UID |
| **å¯ç¼“å­˜æ€§** | âŒ ä¸å¯é  | âœ… å¯é  | UID å¯ä»¥å®‰å…¨ç¼“å­˜ |

---

## ğŸ” å®é™…åœºæ™¯å¯¹æ¯”

### åœºæ™¯ï¼šç”¨æˆ·åˆ—å‡ºé‚®ä»¶å¹¶ç‚¹å‡»æŸ¥çœ‹

#### ä½¿ç”¨åºåˆ—å· âŒ

```
10:00:00 - list_emails è¿”å›:
  {id: 50, subject: "é‡è¦ä¼šè®®"}  â† åºåˆ—å· 50

10:00:30 - æ–°é‚®ä»¶åˆ°è¾¾
  åºåˆ—å· 1-50 â†’ 2-51
  ç°åœ¨ åºåˆ—å· 50 â†’ ä¸åŒçš„é‚®ä»¶ï¼

10:00:45 - ç”¨æˆ·ç‚¹å‡» id=50
  get_email_detail(50) â†’ âŒ è¿”å›é”™è¯¯çš„é‚®ä»¶ï¼
```

#### ä½¿ç”¨ UID âœ…

```
10:00:00 - list_emails è¿”å›:
  {id: 3759, uid: 3759, subject: "é‡è¦ä¼šè®®"}  â† UID 3759

10:00:30 - æ–°é‚®ä»¶åˆ°è¾¾
  æ–°é‚®ä»¶ UID = 3760
  UID 3759 ä»ç„¶ â†’ åŒä¸€å°é‚®ä»¶ âœ…

10:00:45 - ç”¨æˆ·ç‚¹å‡» id=3759
  get_email_detail(3759) â†’ âœ… æ­£ç¡®çš„é‚®ä»¶ï¼
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯• 1: åŸºæœ¬åŠŸèƒ½

```bash
$ python test_account_id_fix.py

âœ… list_emails:        PASS
   é‚®ä»¶ ID: 3759       â† UID
   
âœ… get_email_detail:   PASS
   email_id: 3759     â† ä½¿ç”¨ UID
   uid: 3759          â† ç¡®è®¤æ˜¯ UID
   
ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼
```

### æµ‹è¯• 2: ç¨³å®šæ€§æµ‹è¯•ï¼ˆæ‰‹åŠ¨ï¼‰

```python
# 1. åˆ—å‡ºé‚®ä»¶
emails = fetch_emails(limit=5)
first_id = emails['emails'][0]['id']
first_subject = emails['emails'][0]['subject']

# 2. æ¨¡æ‹Ÿæ–°é‚®ä»¶åˆ°è¾¾ï¼ˆå‘é€ä¸€å°æµ‹è¯•é‚®ä»¶ï¼‰
# ...

# 3. å†æ¬¡è·å–è¯¦æƒ…
detail = get_email_detail(first_id)

# éªŒè¯
assert detail['subject'] == first_subject  # âœ… åº”è¯¥åŒ¹é…
```

### æµ‹è¯• 3: è¿æ¥æ³„æ¼æµ‹è¯•

```python
import threading
import time

def stress_test():
    """å‹åŠ›æµ‹è¯•ï¼šç¡®ä¿è¿æ¥ä¸æ³„æ¼"""
    for i in range(100):
        try:
            result = fetch_emails(limit=10)
            # æ¨¡æ‹Ÿéšæœºé”™è¯¯
            if i % 10 == 0:
                raise Exception("Simulated error")
        except:
            pass
        time.sleep(0.1)

# è¿è¡Œå¤šä¸ªçº¿ç¨‹
threads = [threading.Thread(target=stress_test) for _ in range(5)]
for t in threads:
    t.start()
for t in threads:
    t.join()

# æ£€æŸ¥è¿æ¥æ•°ï¼ˆåº”è¯¥æ²¡æœ‰æ³„æ¼ï¼‰
```

---

## ğŸ“ˆ ä¿®å¤æ•ˆæœ

### å¯é æ€§

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|------|--------|--------|------|
| ID ç¨³å®šæ€§ | âŒ ä¸ç¨³å®š | âœ… 100% ç¨³å®š | âˆ |
| è·¨æ—¶é—´ä¸€è‡´æ€§ | âŒ ä¸ä¸€è‡´ | âœ… ä¸€è‡´ | âˆ |
| è¿æ¥æ³„æ¼é£é™© | âŒ é«˜ | âœ… é›¶ | 100% |

### ç”¨æˆ·ä½“éªŒ

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| æŸ¥çœ‹é‚®ä»¶ | å¯èƒ½çœ‹åˆ°é”™è¯¯é‚®ä»¶ ğŸ˜± | æ€»æ˜¯æ­£ç¡®é‚®ä»¶ âœ… |
| æ ‡è®°å·²è¯» | å¯èƒ½æ ‡è®°é”™è¯¯é‚®ä»¶ ğŸ˜± | æ€»æ˜¯æ­£ç¡®é‚®ä»¶ âœ… |
| åˆ é™¤é‚®ä»¶ | å¯èƒ½åˆ é™¤é”™è¯¯é‚®ä»¶ ğŸ˜± | æ€»æ˜¯æ­£ç¡®é‚®ä»¶ âœ… |
| é•¿æ—¶é—´è¿è¡Œ | è¿æ¥æ³„æ¼å´©æºƒ ğŸ’¥ | ç¨³å®šè¿è¡Œ âœ… |

---

## ğŸ”’ å…³é”®è¦ç‚¹

### 1. å§‹ç»ˆä½¿ç”¨ UID

```python
# âœ… æ­£ç¡®
mail.uid('search', None, 'ALL')
mail.uid('fetch', uid, fetch_parts)

# âŒ é”™è¯¯  
mail.search(None, 'ALL')
mail.fetch(seq_num, fetch_parts)
```

### 2. è¿”å› UID ä½œä¸º ID

```python
# âœ… æ­£ç¡®
{"id": uid, "uid": uid, ...}

# âŒ é”™è¯¯
{"id": sequence_number, ...}
```

### 3. ä¿æŠ¤æ‰€æœ‰ IMAP è¿æ¥

```python
# âœ… æ­£ç¡®
mail = connect()
try:
    # æ“ä½œ
finally:
    mail.logout()

# âŒ é”™è¯¯
mail = connect()
# æ“ä½œ
mail.logout()  # å¯èƒ½æ‰§è¡Œä¸åˆ°
```

---

## ğŸ“ ç›¸å…³ä¿®å¤

è¿™æ˜¯ç»§ä¹‹å‰ä¿®å¤çš„å»¶ç»­ï¼š

1. **UID æ”¯æŒ** (å·²å®Œæˆ) âœ…
   - `get_email_detail`, `mark_email_read`, `delete_email` ç­‰æ”¯æŒ UID
   
2. **Account ID è·¯ç”±** (å·²å®Œæˆ) âœ…
   - ä½¿ç”¨çœŸå®è´¦æˆ· IDï¼Œä¸å›é€€åˆ°é‚®ç®±åœ°å€
   
3. **UID in list_emails** (æœ¬æ¬¡) âœ…
   - `list_emails` ä½¿ç”¨å’Œè¿”å› UID
   - è¿æ¥ä¿æŠ¤
   
4. **å®Œæ•´çš„ UID ç”Ÿæ€** âœ…
   - æ•´ä¸ªç³»ç»Ÿç»Ÿä¸€ä½¿ç”¨ UID
   - ä»åˆ—è¡¨åˆ°è¯¦æƒ…åˆ°æ“ä½œï¼Œå…¨é“¾è·¯ UID

---

## ğŸ¯ éªŒè¯æ¸…å•

éƒ¨ç½²å‰ç¡®è®¤ï¼š

- âœ… `list_emails` è¿”å› UID ä½œä¸º `id`
- âœ… `list_emails` åŒæ—¶åŒ…å« `uid` å­—æ®µ
- âœ… `get_email_detail` æ¥å— UID
- âœ… æ‰€æœ‰æ“ä½œå‡½æ•°æ¥å— UID
- âœ… è¿æ¥æœ‰ try/finally ä¿æŠ¤
- âœ… æµ‹è¯•é€šè¿‡
- âœ… æ‰‹åŠ¨éªŒè¯é‚®ä»¶ ID ç¨³å®šæ€§

---

## ğŸ“š æŠ€æœ¯å‚è€ƒ

### IMAP UID vs åºåˆ—å·

- **åºåˆ—å·**: ä¸´æ—¶æ ‡è¯†ç¬¦ï¼Œä» 1 å¼€å§‹é€’å¢ï¼Œå¯å˜
- **UID**: æ°¸ä¹…æ ‡è¯†ç¬¦ï¼ŒæœåŠ¡å™¨åˆ†é…ï¼Œä¸å˜
- **RFC 3501**: IMAP4rev1 åè®®æ ‡å‡†

### å‘½ä»¤å¯¹æ¯”

```
SEARCH    vs  UID SEARCH
FETCH     vs  UID FETCH
STORE     vs  UID STORE
COPY      vs  UID COPY
```

**è§„åˆ™**ï¼šä»»ä½•éœ€è¦å¼•ç”¨æ¶ˆæ¯çš„åœ°æ–¹ï¼Œä¼˜å…ˆä½¿ç”¨ UID å‘½ä»¤ã€‚

---

ä¿®å¤å®Œæˆï¼ğŸ”’ ç°åœ¨ç³»ç»Ÿå…·æœ‰çœŸæ­£çš„ç¨³å®šæ€§ã€‚


