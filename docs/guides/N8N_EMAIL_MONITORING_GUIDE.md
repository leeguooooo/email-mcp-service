# ğŸ¤– n8n + AI æ™ºèƒ½é‚®ä»¶ç›‘æ§ä¸é€šçŸ¥ç³»ç»Ÿ

è¿™æ˜¯ä¸€ä¸ªå®Œæ•´çš„è§£å†³æ–¹æ¡ˆï¼Œè®©ä½ å¯ä»¥ä½¿ç”¨ n8n å®šæ—¶è§¦å‘é‚®ä»¶ç›‘æ§ï¼Œé€šè¿‡ AI è¿‡æ»¤é‡è¦é‚®ä»¶ï¼Œå¹¶è‡ªåŠ¨å‘é€ webhook é€šçŸ¥åˆ°é’‰é’‰ã€é£ä¹¦ã€ä¼ä¸šå¾®ä¿¡ç­‰å¹³å°ã€‚

## ğŸŒŸ ç³»ç»Ÿç‰¹æ€§

- **ğŸ”„ è‡ªåŠ¨åŒ–ç›‘æ§**: n8n å®šæ—¶è§¦å‘ï¼Œæ— éœ€äººå·¥å¹²é¢„
- **ğŸ§  AI æ™ºèƒ½è¿‡æ»¤**: ä½¿ç”¨ OpenAI/Claude ç­‰ AI åˆ¤æ–­é‚®ä»¶é‡è¦æ€§
- **ğŸ“± å¤šå¹³å°é€šçŸ¥**: æ”¯æŒé’‰é’‰ã€é£ä¹¦ã€ä¼ä¸šå¾®ä¿¡ã€Slack ç­‰
- **ğŸ”’ å»é‡ä¿æŠ¤**: é¿å…é‡å¤é€šçŸ¥åŒä¸€å°é‚®ä»¶
- **âš¡ é«˜æ€§èƒ½**: å¹¶è¡Œå¤„ç†ï¼Œæ”¯æŒå¤šè´¦æˆ·
- **ğŸ›¡ï¸ é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶
- **ğŸ“Š ç›‘æ§ç»Ÿè®¡**: è¿è¡ŒçŠ¶æ€å’ŒæˆåŠŸç‡ç»Ÿè®¡

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   n8n å®šæ—¶   â”‚â”€â”€â”€â–¶â”‚  é‚®ä»¶è·å–     â”‚â”€â”€â”€â–¶â”‚  AI è¿‡æ»¤     â”‚â”€â”€â”€â–¶â”‚  Webhooké€šçŸ¥  â”‚
â”‚   è§¦å‘å™¨     â”‚    â”‚  (MCPå·¥å…·)   â”‚    â”‚  (æ™ºèƒ½åˆ¤æ–­)  â”‚    â”‚  (å¤šå¹³å°)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚                    â”‚                   â”‚
                           â–¼                    â–¼                   â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   é‚®ä»¶ç¼“å­˜    â”‚    â”‚  è¿‡æ»¤è§„åˆ™    â”‚    â”‚   å»é‡æ•°æ®åº“  â”‚
                    â”‚   (SQLite)   â”‚    â”‚  (é…ç½®æ–‡ä»¶)  â”‚    â”‚   (SQLite)   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ä¸€é”®è®¾ç½®

```bash
# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
git clone https://github.com/leeguooooo/email-mcp-service.git
cd mcp-email-service

# è¿è¡Œè‡ªåŠ¨è®¾ç½®è„šæœ¬
python scripts/setup_n8n_monitoring.py
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- âœ… æ£€æŸ¥æ‰€æœ‰ä¾èµ–é¡¹
- âœ… å®‰è£…ç¼ºå¤±çš„ Python åŒ…
- âœ… åˆ›å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿
- âœ… æµ‹è¯•å„ä¸ªç»„ä»¶
- âœ… ç”Ÿæˆ n8n é…ç½®è¯´æ˜

### 2. é…ç½®é‚®ä»¶è´¦æˆ·

```bash
# é…ç½®é‚®ä»¶è´¦æˆ·ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
python setup.py
```

### 3. è®¾ç½® API å¯†é’¥

```bash
# OpenAI (æ¨è)
export OPENAI_API_KEY="your_openai_api_key"

# æˆ–è€… Anthropic Claude
export ANTHROPIC_API_KEY="your_anthropic_api_key"

# è®¾ç½® Python è·¯å¾„
export PYTHONPATH="/path/to/mcp-email-service:$PYTHONPATH"
```

### 4. é…ç½® Webhook

ç¼–è¾‘ `notification_config.json`ï¼Œè®¾ç½®ä½ çš„ webhook URLï¼š

```json
{
  "webhooks": [
    {
      "name": "dingtalk_main",
      "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN",
      "webhook_type": "dingtalk",
      "secret": "YOUR_SECRET",
      "enabled": true
    }
  ]
}
```

### 5. å¯¼å…¥ n8n å·¥ä½œæµ

1. æ‰“å¼€ n8n ç•Œé¢
2. ç‚¹å‡» "Import from file"
3. é€‰æ‹© `n8n/email_monitoring_workflow.json`
4. ä¿®æ”¹ "é‚®ä»¶ç›‘æ§" èŠ‚ç‚¹ä¸­çš„è„šæœ¬è·¯å¾„
5. é…ç½® webhook URL
6. å¯åŠ¨å·¥ä½œæµ

## ğŸ“ é¡¹ç›®ç»“æ„

```
mcp-email-service/
â”œâ”€â”€ scripts/                          # æ ¸å¿ƒè„šæœ¬
â”‚   â”œâ”€â”€ call_email_tool.py            # é‚®ä»¶å·¥å…·æ¡¥æ¥
â”‚   â”œâ”€â”€ ai_email_filter.py            # AI è¿‡æ»¤æœåŠ¡
â”‚   â”œâ”€â”€ notification_service.py       # é€šçŸ¥æœåŠ¡
â”‚   â”œâ”€â”€ email_monitor.py              # ä¸»æ§åˆ¶è„šæœ¬
â”‚   â””â”€â”€ setup_n8n_monitoring.py       # è‡ªåŠ¨è®¾ç½®è„šæœ¬
â”œâ”€â”€ n8n/                              # n8n å·¥ä½œæµ
â”‚   â”œâ”€â”€ email_monitoring_workflow.json # å·¥ä½œæµé…ç½®
â”‚   â””â”€â”€ README.md                     # n8n è¯¦ç»†è¯´æ˜
â”œâ”€â”€ config_templates/                 # é…ç½®æ¨¡æ¿
â”‚   â”œâ”€â”€ ai_filter_config.example.json
â”‚   â”œâ”€â”€ notification_config.example.json
â”‚   â””â”€â”€ email_monitor_config.example.json
â””â”€â”€ é…ç½®æ–‡ä»¶ (è‡ªåŠ¨ç”Ÿæˆ)
    â”œâ”€â”€ ai_filter_config.json         # AI è¿‡æ»¤é…ç½®
    â”œâ”€â”€ notification_config.json      # é€šçŸ¥é…ç½®
    â””â”€â”€ email_monitor_config.json     # ç›‘æ§é…ç½®
```

## ğŸ”§ è¯¦ç»†é…ç½®

### AI è¿‡æ»¤é…ç½® (`ai_filter_config.json`)

```json
{
  "ai_provider": "openai",              // AI æä¾›å•†: openai, anthropic
  "model": "gpt-3.5-turbo",            // æ¨¡å‹åç§°
  "priority_threshold": 0.7,           // é‡è¦æ€§é˜ˆå€¼ (0-1)
  "filter_rules": {
    "high_priority_senders": [         // é«˜ä¼˜å…ˆçº§å‘ä»¶äºº
      "boss@company.com",
      "important@client.com"
    ],
    "high_priority_keywords": [        // é‡è¦å…³é”®è¯
      "urgent", "important", "ç´§æ€¥", "é‡è¦"
    ],
    "low_priority_keywords": [         // ä½ä¼˜å…ˆçº§å…³é”®è¯
      "newsletter", "promotion", "å¹¿å‘Š"
    ]
  }
}
```

### é€šçŸ¥é…ç½® (`notification_config.json`)

```json
{
  "webhooks": [
    {
      "name": "dingtalk_main",
      "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=YOUR_TOKEN",
      "webhook_type": "dingtalk",      // æ”¯æŒ: dingtalk, feishu, wechat, slack, custom
      "secret": "YOUR_SECRET",         // ç­¾åå¯†é’¥ï¼ˆé’‰é’‰ã€é£ä¹¦éœ€è¦ï¼‰
      "retry_times": 3,                // é‡è¯•æ¬¡æ•°
      "enabled": true,                 // æ˜¯å¦å¯ç”¨
      "template": "dingtalk"           // æ¶ˆæ¯æ¨¡æ¿
    }
  ],
  "deduplication": {
    "enabled": true,                   // å¯ç”¨å»é‡
    "window_hours": 24,               // å»é‡æ—¶é—´çª—å£ï¼ˆå°æ—¶ï¼‰
    "cleanup_days": 7                 // æ¸…ç†å†å²è®°å½•ï¼ˆå¤©ï¼‰
  }
}
```

### ç›‘æ§é…ç½® (`email_monitor_config.json`)

```json
{
  "email": {
    "fetch_limit": 20,                // æ¯æ¬¡è·å–é‚®ä»¶æ•°é‡
    "unread_only": true,              // åªè·å–æœªè¯»é‚®ä»¶
    "account_id": null,               // æŒ‡å®šè´¦æˆ·IDï¼ˆnull=æ‰€æœ‰è´¦æˆ·ï¼‰
    "folder": "INBOX"                 // é‚®ä»¶æ–‡ä»¶å¤¹
  },
  "ai_filter": {
    "enabled": true,                  // å¯ç”¨AIè¿‡æ»¤
    "priority_threshold": 0.7         // é‡è¦æ€§é˜ˆå€¼
  },
  "notification": {
    "enabled": true,                  // å¯ç”¨é€šçŸ¥
    "webhook_names": null             // æŒ‡å®šwebhookï¼ˆnull=æ‰€æœ‰å¯ç”¨çš„ï¼‰
  }
}
```

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### æµ‹è¯•å•ä¸ªç»„ä»¶

```bash
# æµ‹è¯•é‚®ä»¶è·å–
python scripts/call_email_tool.py list_unread_emails '{"limit":5}'

# æµ‹è¯• AI è¿‡æ»¤
python scripts/ai_email_filter.py '[{"id":"test","subject":"Urgent meeting","from":"boss@company.com","date":"2024-01-15","body_preview":"We need to discuss..."}]'

# æµ‹è¯•é€šçŸ¥å‘é€
python scripts/notification_service.py test

# æµ‹è¯•å®Œæ•´æµç¨‹
python scripts/email_monitor.py run
```

### æŸ¥çœ‹è¿è¡ŒçŠ¶æ€

```bash
# æŸ¥çœ‹ç›‘æ§çŠ¶æ€
python scripts/email_monitor.py status

# æŸ¥çœ‹é€šçŸ¥ç»Ÿè®¡
python scripts/notification_service.py stats 7

# æŸ¥çœ‹é…ç½®
python scripts/email_monitor.py config
```

### è°ƒè¯•æŠ€å·§

1. **æŸ¥çœ‹æ—¥å¿—**:
   ```bash
   tail -f email_monitor.log
   ```

2. **n8n è°ƒè¯•**:
   - ä½¿ç”¨ n8n çš„æ‰§è¡Œå†å²æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
   - åœ¨ä»£ç èŠ‚ç‚¹ä¸­æ·»åŠ  `console.log()` è¾“å‡ºè°ƒè¯•ä¿¡æ¯

3. **æ‰‹åŠ¨æµ‹è¯•**:
   ```bash
   # æµ‹è¯•ç‰¹å®šç»„ä»¶
   python scripts/setup_n8n_monitoring.py --test-only
   ```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### è¿è¡Œç»Ÿè®¡

ç³»ç»Ÿä¼šè‡ªåŠ¨è®°å½•ä»¥ä¸‹ç»Ÿè®¡ä¿¡æ¯ï¼š
- ğŸ“¥ è·å–é‚®ä»¶æ•°é‡
- âš ï¸ é‡è¦é‚®ä»¶æ•°é‡  
- ğŸ“¤ å‘é€é€šçŸ¥æ•°é‡
- âœ… æˆåŠŸç‡ç»Ÿè®¡
- â±ï¸ è¿è¡Œæ—¶é—´

### æ€§èƒ½ä¼˜åŒ–

1. **è°ƒæ•´ç›‘æ§é¢‘ç‡**: æ ¹æ®é‚®ä»¶é‡è°ƒæ•´ n8n å®šæ—¶å™¨
2. **ä¼˜åŒ– AI è¿‡æ»¤**: ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹æˆ–æœ¬åœ°æ¨¡å‹
3. **æ‰¹é‡å¤„ç†**: å¢åŠ  `fetch_limit` å‡å°‘è°ƒç”¨é¢‘ç‡
4. **ç¼“å­˜ä¼˜åŒ–**: ä½¿ç”¨é‚®ä»¶ç¼“å­˜å‡å°‘é‡å¤è·å–

### æ•…éšœå¤„ç†

å¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆï¼š

| é—®é¢˜ | å¯èƒ½åŸå›  | è§£å†³æ–¹æ¡ˆ |
|------|----------|----------|
| è„šæœ¬æ‰§è¡Œå¤±è´¥ | è·¯å¾„æˆ–ä¾èµ–é—®é¢˜ | æ£€æŸ¥ Python è·¯å¾„å’Œä¾èµ–å®‰è£… |
| AI è¿‡æ»¤å¤±è´¥ | API å¯†é’¥æˆ–ç½‘ç»œé—®é¢˜ | éªŒè¯ API å¯†é’¥ï¼Œæ£€æŸ¥ç½‘ç»œè¿æ¥ |
| é€šçŸ¥å‘é€å¤±è´¥ | Webhook URL æˆ–ç­¾åé—®é¢˜ | éªŒè¯ URL å’Œç­¾åé…ç½® |
| é‡å¤é€šçŸ¥ | å»é‡é…ç½®é—®é¢˜ | æ£€æŸ¥å»é‡è®¾ç½®ï¼Œæ¸…ç†å†å²è®°å½• |

## ğŸ”’ å®‰å…¨æ³¨æ„äº‹é¡¹

1. **API å¯†é’¥å®‰å…¨**:
   - ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å¯†é’¥
   - å®šæœŸè½®æ¢å¯†é’¥
   - é™åˆ¶ API å¯†é’¥æƒé™

2. **Webhook å®‰å…¨**:
   - ä½¿ç”¨ HTTPS URL
   - é…ç½®ç­¾åéªŒè¯
   - é™åˆ¶è®¿é—®æƒé™

3. **é‚®ä»¶å†…å®¹éšç§**:
   - æ³¨æ„å‘é€ç»™ AI çš„å†…å®¹
   - è€ƒè™‘ä½¿ç”¨æœ¬åœ° AI æ¨¡å‹
   - é…ç½®å†…å®¹è¿‡æ»¤è§„åˆ™

## ğŸš€ é«˜çº§åŠŸèƒ½

### 1. å¤šè´¦æˆ·æ”¯æŒ

```json
{
  "email": {
    "account_id": "account1",  // æŒ‡å®šç‰¹å®šè´¦æˆ·
    "folder": "INBOX"
  }
}
```

### 2. è‡ªå®šä¹‰è¿‡æ»¤è§„åˆ™

```json
{
  "filter_rules": {
    "high_priority_senders": ["vip@company.com"],
    "category_keywords": {
      "urgent": ["urgent", "asap", "ç´§æ€¥"],
      "meeting": ["meeting", "ä¼šè®®", "conference"],
      "finance": ["invoice", "payment", "å‘ç¥¨", "ä»˜æ¬¾"]
    }
  }
}
```

### 3. å¤š Webhook æ”¯æŒ

```json
{
  "webhooks": [
    {
      "name": "urgent_channel",
      "webhook_url": "...",
      "enabled": true
    },
    {
      "name": "general_channel", 
      "webhook_url": "...",
      "enabled": true
    }
  ]
}
```

### 4. æ¡ä»¶é€šçŸ¥

åœ¨ n8n ä¸­å¯ä»¥æ·»åŠ æ¡ä»¶èŠ‚ç‚¹ï¼Œæ ¹æ®ä¸åŒæ¡ä»¶å‘é€åˆ°ä¸åŒçš„ webhookï¼š

```javascript
// n8n æ¡ä»¶èŠ‚ç‚¹ç¤ºä¾‹
if ($json.category === 'urgent') {
  return [{ json: { webhook: 'urgent_channel' } }];
} else {
  return [{ json: { webhook: 'general_channel' } }];
}
```

## ğŸ“ æ”¯æŒå’Œè´¡çŒ®

### è·å–å¸®åŠ©

1. æŸ¥çœ‹ [n8n/README.md](n8n/README.md) è·å–è¯¦ç»†çš„ n8n é…ç½®è¯´æ˜
2. è¿è¡Œ `python scripts/setup_n8n_monitoring.py --help` æŸ¥çœ‹è®¾ç½®é€‰é¡¹
3. æŸ¥çœ‹é¡¹ç›® Issues æˆ–æäº¤æ–°çš„é—®é¢˜

### è´¡çŒ®ä»£ç 

æ¬¢è¿æäº¤ Pull Request æ¥æ”¹è¿›è¿™ä¸ªç³»ç»Ÿï¼š
- ğŸ› ä¿®å¤ Bug
- âœ¨ æ·»åŠ æ–°åŠŸèƒ½
- ğŸ“š æ”¹è¿›æ–‡æ¡£
- ğŸ§ª æ·»åŠ æµ‹è¯•

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®éµå¾ª MIT è®¸å¯è¯ã€‚

---

**ğŸ‰ ç°åœ¨ä½ å°±æœ‰äº†ä¸€ä¸ªå®Œå…¨è‡ªåŠ¨åŒ–çš„æ™ºèƒ½é‚®ä»¶ç›‘æ§ç³»ç»Ÿï¼**

ç³»ç»Ÿä¼šè‡ªåŠ¨ï¼š
1. â° æ¯ 5 åˆ†é’Ÿæ£€æŸ¥æ–°é‚®ä»¶
2. ğŸ¤– ä½¿ç”¨ AI åˆ¤æ–­é‚®ä»¶é‡è¦æ€§
3. ğŸ“± å‘é€é‡è¦é‚®ä»¶é€šçŸ¥åˆ°ä½ çš„å·¥ä½œç¾¤
4. ğŸ”„ é¿å…é‡å¤é€šçŸ¥
5. ğŸ“Š è®°å½•è¿è¡Œç»Ÿè®¡

äº«å—æ™ºèƒ½é‚®ä»¶ç®¡ç†å¸¦æ¥çš„ä¾¿åˆ©å§ï¼ ğŸš€
