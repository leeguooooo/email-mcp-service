{
  "name": "æ™ºèƒ½é‚®ä»¶ç›‘æ§ä¸é€šçŸ¥",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/5 * * * *"
            }
          ]
        }
      },
      "id": "cron-trigger",
      "name": "å®šæ—¶è§¦å‘å™¨",
      "type": "n8n-nodes-base.cron",
      "typeVersion": 1,
      "position": [
        240,
        300
      ]
    },
    {
      "parameters": {
        "command": "python",
        "arguments": "/Users/leo/github.com/mcp-email-service/scripts/email_monitor.py run",
        "options": {
          "cwd": "/Users/leo/github.com/mcp-email-service",
          "timeout": 600000,
          "output": "json",
          "continueOnFail": true
        }
      },
      "id": "email-monitor",
      "name": "é‚®ä»¶ç›‘æ§",
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [
        460,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// è§£æé‚®ä»¶ç›‘æ§ç»“æœ\nconst input = $input.first().json;\nconst exitCode = input.exitCode || 0;\nconst stderr = input.stderr || '';\nconst stdout = input.stdout || '';\n\n// é¦–å…ˆæ£€æŸ¥è„šæœ¬æ‰§è¡ŒçŠ¶æ€\nif (exitCode !== 0) {\n  throw new Error(`è„šæœ¬æ‰§è¡Œå¤±è´¥ (é€€å‡ºç : ${exitCode})\\né”™è¯¯ä¿¡æ¯: ${stderr}\\nè¾“å‡º: ${stdout}`);\n}\n\n// æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡º\nif (!stdout || stdout.trim() === '') {\n  throw new Error('è„šæœ¬æ²¡æœ‰è¿”å›ä»»ä½•è¾“å‡º');\n}\n\n// è§£æ JSON è¾“å‡º\nlet result;\ntry {\n  result = JSON.parse(stdout);\n} catch (parseError) {\n  throw new Error(`JSON è§£æå¤±è´¥: ${parseError.message}\\nåŸå§‹è¾“å‡º: ${stdout}`);\n}\n\n// æ£€æŸ¥ä¸šåŠ¡é€»è¾‘æ˜¯å¦æˆåŠŸ\nif (!result.success) {\n  throw new Error(`é‚®ä»¶ç›‘æ§å¤±è´¥: ${result.error || 'æœªçŸ¥é”™è¯¯'}`);\n}\n\n// æå–ç»Ÿè®¡ä¿¡æ¯\nconst stats = result.stats || {};\nconst details = result.details || {};\n\n// å‡†å¤‡è¾“å‡ºæ•°æ®\nreturn {\n  json: {\n    success: result.success,\n    message: result.message,\n    stats: stats,\n    timestamp: new Date().toISOString(),\n    // å¦‚æœæœ‰é‡è¦é‚®ä»¶ï¼Œå‡†å¤‡é€šçŸ¥æ•°æ®\n    hasImportantEmails: stats.important_emails > 0,\n    importantEmailsCount: stats.important_emails,\n    fetchedEmailsCount: stats.fetched_emails,\n    notificationsSent: stats.notifications_sent,\n    // è¯¦ç»†ç»“æœç”¨äºè°ƒè¯•\n    details: details,\n    // æ·»åŠ  webhook URL ä¾›åç»­èŠ‚ç‚¹ä½¿ç”¨\n    webhookUrl: $env.FEISHU_WEBHOOK\n  }\n};"
      },
      "id": "parse-results",
      "name": "è§£æç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-important-emails",
              "leftValue": "={{ $json.hasImportantEmails }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equal"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-important-emails",
      "name": "æ£€æŸ¥é‡è¦é‚®ä»¶",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡ç®¡ç†å‘˜é€šçŸ¥å†…å®¹\nconst inputData = $input.first().json;\nconst stats = inputData.stats || {};\nconst timestamp = inputData.timestamp;\n\n// æ„å»ºé£ä¹¦å¡ç‰‡æ¶ˆæ¯\nconst message = {\n  \"msg_type\": \"interactive\",\n  \"card\": {\n    \"elements\": [\n      {\n        \"tag\": \"div\",\n        \"text\": {\n          \"content\": `**ğŸ“Š ç›‘æ§ç»Ÿè®¡**\\n\\n` +\n                     `ğŸ“¥ **è·å–é‚®ä»¶**: ${stats.fetchedEmailsCount || 0} å°\\n` +\n                     `âš ï¸ **é‡è¦é‚®ä»¶**: ${stats.importantEmailsCount || 0} å°\\n` +\n                     `ğŸ“¤ **å‘é€é€šçŸ¥**: ${stats.notificationsSent || 0} æ¡\\n\\n` +\n                     `ğŸ• **æ£€æŸ¥æ—¶é—´**: ${new Date(timestamp).toLocaleString('zh-CN')}\\n\\n` +\n                     `ğŸ“ˆ **è¿è¡ŒçŠ¶æ€**: ${stats.importantEmailsCount > 0 ? 'ğŸ”´ å‘ç°é‡è¦é‚®ä»¶' : 'ğŸŸ¢ è¿è¡Œæ­£å¸¸'}`,\n          \"tag\": \"lark_md\"\n        }\n      }\n    ],\n    \"header\": {\n      \"title\": {\n        \"content\": \"ğŸ“§ é‚®ä»¶ç›‘æ§æŠ¥å‘Š\",\n        \"tag\": \"plain_text\"\n      },\n      \"template\": stats.importantEmailsCount > 0 ? \"red\" : \"green\"\n    }\n  }\n};\n\n// æ·»åŠ  webhook URL åˆ°è¾“å‡º\nreturn {\n  json: {\n    ...message,\n    webhookUrl: inputData.webhookUrl || $env.FEISHU_WEBHOOK\n  }\n};"
      },
      "id": "prepare-admin-notification",
      "name": "å‡†å¤‡ç®¡ç†å‘˜é€šçŸ¥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        200
      ]
    },
    {
      "parameters": {
        "url": "={{ $json.webhookUrl || $json.destination?.webhook || $env.FEISHU_WEBHOOK }}",
        "options": {
          "headers": {
            "Content-Type": "application/json"
          },
          "allowUnauthorizedCerts": false
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}"
      },
      "id": "send-admin-notification",
      "name": "å‘é€ç®¡ç†å‘˜é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1340,
        200
      ]
    },
    {
      "parameters": {
        "jsCode": "// è®°å½•ç›‘æ§æ—¥å¿—\nconst result = $input.first().json;\nconst timestamp = new Date().toISOString();\n\n// æ„å»ºæ—¥å¿—æ¡ç›®\nconst logEntry = {\n  timestamp: timestamp,\n  success: result.success,\n  message: result.message,\n  stats: result.stats,\n  level: result.success ? 'INFO' : 'ERROR'\n};\n\n// è¾“å‡ºåˆ°æ§åˆ¶å°ï¼ˆn8n ä¼šè®°å½•ï¼‰\nconsole.log(`[${logEntry.level}] ${timestamp}: ${result.message}`);\nif (result.stats) {\n  console.log(`Stats: ${JSON.stringify(result.stats)}`);\n}\n\nreturn {\n  json: logEntry\n};"
      },
      "id": "log-results",
      "name": "è®°å½•æ—¥å¿—",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// é”™è¯¯å¤„ç†å’Œé€šçŸ¥\nconst input = $input.first();\nconst error = input.error;\nconst json = input.json || {};\nconst timestamp = new Date().toISOString();\n\n// æå–é”™è¯¯ä¿¡æ¯\nlet errorMessage = 'æœªçŸ¥é”™è¯¯';\nlet errorDetails = '';\n\nif (error) {\n  errorMessage = error.message || error.toString();\n  // å¦‚æœæ˜¯è„šæœ¬æ‰§è¡Œé”™è¯¯ï¼Œæå–æ›´å¤šä¿¡æ¯\n  if (error.message && error.message.includes('è„šæœ¬æ‰§è¡Œå¤±è´¥')) {\n    errorDetails = error.message;\n  }\n} else if (json.exitCode && json.exitCode !== 0) {\n  errorMessage = `è„šæœ¬é€€å‡ºç : ${json.exitCode}`;\n  errorDetails = `stderr: ${json.stderr || 'N/A'}\\nstdout: ${json.stdout || 'N/A'}`;\n} else if (json.error) {\n  errorMessage = json.error;\n}\n\n// æ„å»ºé£ä¹¦é”™è¯¯é€šçŸ¥ (ä½¿ç”¨ msg_type)\nconst errorNotification = {\n  \"msg_type\": \"text\",\n  \"content\": {\n    \"text\": `ğŸš¨ é‚®ä»¶ç›‘æ§ç³»ç»Ÿé”™è¯¯\\n\\n` +\n             `æ—¶é—´: ${new Date(timestamp).toLocaleString('zh-CN')}\\n` +\n             `é”™è¯¯: ${errorMessage}\\n` +\n             (errorDetails ? `\\nè¯¦ç»†ä¿¡æ¯:\\n${errorDetails}\\n` : '') +\n             `\\nè¯·æ£€æŸ¥ç³»ç»ŸçŠ¶æ€å¹¶åŠæ—¶å¤„ç†ã€‚`\n  }\n};\n\n// è®°å½•é”™è¯¯åˆ°æ§åˆ¶å°\nconsole.error('é‚®ä»¶ç›‘æ§ç³»ç»Ÿé”™è¯¯:', {\n  timestamp,\n  error: errorMessage,\n  details: errorDetails,\n  input: input\n});\n\nreturn {\n  json: errorNotification\n};"
      },
      "id": "handle-error",
      "name": "é”™è¯¯å¤„ç†",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        680,
        500
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ $env.FEISHU_WEBHOOK }}",
        "options": {
          "headers": {
            "Content-Type": "application/json"
          },
          "allowUnauthorizedCerts": false
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ $json }}"
      },
      "id": "send-error-notification",
      "name": "å‘é€é”™è¯¯é€šçŸ¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        900,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "// å¥åº·æ£€æŸ¥å’Œç»Ÿè®¡\nconst result = $input.first().json;\nconst timestamp = new Date();\n\n// è®¡ç®—æˆåŠŸç‡ï¼ˆå¯ä»¥åŸºäºå†å²æ•°æ®ï¼‰\nconst healthStatus = {\n  timestamp: timestamp.toISOString(),\n  status: result.success ? 'healthy' : 'unhealthy',\n  uptime: process.uptime(),\n  stats: result.stats,\n  lastCheck: timestamp.toLocaleString('zh-CN')\n};\n\n// å¯ä»¥å°†å¥åº·çŠ¶æ€å†™å…¥æ•°æ®åº“æˆ–æ–‡ä»¶\n// è¿™é‡Œåªæ˜¯è¾“å‡ºåˆ°æ—¥å¿—\nconsole.log(`Health Check: ${JSON.stringify(healthStatus)}`);\n\nreturn {\n  json: healthStatus\n};"
      },
      "id": "health-check",
      "name": "å¥åº·æ£€æŸ¥",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1340,
        400
      ]
    }
  ],
  "connections": {
    "å®šæ—¶è§¦å‘å™¨": {
      "main": [
        [
          {
            "node": "é‚®ä»¶ç›‘æ§",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é‚®ä»¶ç›‘æ§": {
      "main": [
        [
          {
            "node": "è§£æç»“æœ",
            "type": "main",
            "index": 0
          }
        ]
      ],
      "error": [
        [
          {
            "node": "é”™è¯¯å¤„ç†",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æç»“æœ": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥é‡è¦é‚®ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥é‡è¦é‚®ä»¶": {
      "main": [
        [
          {
            "node": "å‡†å¤‡ç®¡ç†å‘˜é€šçŸ¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "è®°å½•æ—¥å¿—",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "è®°å½•æ—¥å¿—",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡ç®¡ç†å‘˜é€šçŸ¥": {
      "main": [
        [
          {
            "node": "å‘é€ç®¡ç†å‘˜é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‘é€ç®¡ç†å‘˜é€šçŸ¥": {
      "main": [
        [
          {
            "node": "å¥åº·æ£€æŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è®°å½•æ—¥å¿—": {
      "main": [
        [
          {
            "node": "å¥åº·æ£€æŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "é”™è¯¯å¤„ç†": {
      "main": [
        [
          {
            "node": "å‘é€é”™è¯¯é€šçŸ¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "createdAt": "2024-01-15T10:00:00.000Z",
      "updatedAt": "2024-01-15T10:00:00.000Z",
      "id": "email-monitoring",
      "name": "é‚®ä»¶ç›‘æ§"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-01-15T10:00:00.000Z",
  "versionId": "1"
}
