# 混合查询模式说明

## 概述

混合查询模式结合了本地缓存和远程IMAP查询的优势，提供更快的响应速度和更好的用户体验。

## 架构设计

### 1. 核心组件

- **HybridEmailManager**: 混合查询管理器，智能决策是否使用缓存
- **EmailSyncDatabase**: 本地SQLite数据库，存储邮件元数据
- **HybridConfig**: 配置管理器，控制混合模式行为
- **HybridEmailToolHandlers**: 替代标准处理器的混合版本

### 2. 查询策略

```
用户请求 → 混合管理器 → 判断数据新鲜度
                            ↓
                    新鲜？ → 返回本地数据
                      ↓
                    不新鲜 → 快速同步 → 返回更新数据
```

### 3. 写操作策略

所有写操作（标记、删除、移动）采用写透式更新：
1. 先更新远程IMAP服务器
2. 成功后更新本地数据库
3. 保证数据一致性

## 配置说明

### 启用/禁用混合模式

编辑 `hybrid_config.json`:

```json
{
  "hybrid_mode": {
    "enabled": true  // true启用，false禁用
  }
}
```

### 关键配置项

1. **freshness_threshold_minutes**: 数据新鲜度阈值（默认5分钟）
   - 超过此时间的数据被认为是过期的
   - 可以为不同工具设置不同阈值

2. **auto_sync_on_search**: 搜索时自动同步（默认true）
   - 搜索操作会触发快速同步确保结果完整

3. **unread_always_fresh**: 未读邮件总是获取最新（默认true）
   - 确保不会错过新邮件

## 使用方式

### MCP工具中的新参数

所有读取类工具新增 `use_cache` 参数：

```bash
# 强制使用缓存（离线模式）
list_emails with use_cache=true

# 强制从远程获取（实时模式）
list_emails with use_cache=false

# 自动判断（默认）
list_emails
```

### 数据新鲜度查看

```bash
# 查看各账户文件夹的数据新鲜度
get_freshness_status
```

## 性能优化

### 1. 快速同步

- 只同步最新的10-20封邮件
- 优先同步重要文件夹（INBOX、Sent、Drafts）
- 设置合理的超时时间（默认10秒）

### 2. 并行处理

- 多账户并行同步
- 批量操作优化
- 连接复用

### 3. 智能缓存

- 邮件元数据积极缓存
- 邮件正文按需获取
- 附件信息缓存，内容按需下载

## 故障处理

### 降级策略

1. 远程服务器不可用时，自动使用本地缓存
2. 添加警告提示数据可能不是最新
3. 写操作失败时保留操作队列，后续重试

### 监控和日志

- 所有混合查询决策都有日志记录
- 性能指标（缓存命中率、同步耗时）
- 错误和警告及时记录

## 最佳实践

1. **合理设置新鲜度阈值**
   - 邮件列表：5分钟
   - 搜索结果：10分钟
   - 邮件详情：始终获取最新

2. **定期后台同步**
   - 使用 `sync_manager.py` 保持数据更新
   - 配置合理的同步间隔

3. **监控数据库大小**
   - 定期清理旧邮件
   - 使用软删除避免数据丢失

4. **网络优化**
   - 在网络条件差时增大超时时间
   - 使用缓存优先模式

## 故障排查

1. **邮件显示不全**
   - 检查同步状态：`sync_emails with action="status"`
   - 强制同步：`sync_emails with action="force"`

2. **响应缓慢**
   - 检查新鲜度状态：`get_freshness_status`
   - 调整 `freshness_threshold_minutes`

3. **数据不一致**
   - 检查数据库完整性
   - 重新同步特定账户

## 未来改进

1. 支持IMAP IDLE推送通知
2. 增量搜索优化
3. 智能预取策略
4. 压缩存储优化